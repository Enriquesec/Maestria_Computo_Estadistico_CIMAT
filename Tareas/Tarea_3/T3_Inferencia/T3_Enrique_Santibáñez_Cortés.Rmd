---
fontsize: 11pt
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
documentclass: article
output:
    pdf_document:
        includes:
            in_header: mystyles.sty
---
\begin{table}[ht]
\centering
\begin{tabular}{c}
\textbf{Maestría en Computo Estadístico}\\
\textbf{Inferencia Estadística} \\
\textbf{Tarea 2}\\
\today \\
\emph{Enrique Santibáñez Cortés}\\
Repositorio de Git: \href{https://github.com/Enriquesec/Inferencia_Estad-stica/tree/master/Tareas/Tarea_2}{Tarea 2, IE}.
\end{tabular}
\end{table}

4. El siguiente conjuntos de datos contiene mediciones del diámetro de un agave, medido en decímetros, en distintas localizaciones no cercanas.
\begin{equation*}
\begin{array}{cccccccccc}
23.37 & 21.87 & 24.41 & 21.27 & 23.33 & 15.20 & 24.21 & 27.52 & 15.48 & 27.19 \\
25.05 & 20.40 & 21.05 & 28.83 & 22.90 & 18.00 & 17.55 & 25.92 & 23.64 & 28.96 \\
23.02 & 17.32 & 30.74 & 26.73 & 17.22 & 22.81 & 20.78 & 23.17 & 21.60 & 22.37
\end{array}
\end{equation*}
a) Escriba una función en R que calcule la función de distribución empírica para un conjunto de datos dado $D$. La función debe tomar como parámetros al valor $x$ donde se evalúa y al conjunto de datos $D$. Utilizando esta función grafique la función de distribución empírica asociada al conjunto de datos de agave. Ponga atención a los puntos de discontinuidad. ¿Qué observa? \textbf{Nota}: Escriba la función mediante el algoritmo descrito en las notas de la clase; para este ejercicio no vale usar la funciones implementadas en R que hacen lo pedido.

\res Sea $X_i, \cdots , X_n\sim F$, la función de densidad empírica $\hat{F}$ es la función de distribución acumulada que asigna masa 1/n en cada punto $X_i$. Formalmente,
$$\hat{F}(x)=\frac{\sum_{1=i}^n 1_{X_i\leq x}}{n},$$
donde $$1_{X_i\leq x} = \left\{ \begin{array}{cc} 1 & \text{si } X_i\leq x\\
0 & \text{si } X_i >x\end{array}\right.$$
Utilizando la definición anterior construímos la función en R:
```{r}
fde <- function(x, D){
  n <- length(D)
  fde_x <- sum(D<x)/n
}
```
Procedemos a calcular con la función anterior la fde en los puntos de discontinuidad, para ello primero ingresemos los datos:
```{r}
diametro_agave<-c(23.37, 21.87, 24.41, 21.27, 23.33, 15.20, 24.21, 27.52, 15.48, 27.19,
25.05, 20.40, 21.05, 28.83, 22.90, 18.00, 17.55, 25.92, 23.64, 28.96, 23.02, 17.32, 
30.74, 26.73, 17.22, 22.81, 20.78, 23.17, 21.60, 22.37)


sort(diametro_agave)
```
Los puntos de discontinuidad serían cuando cambia fde, es decir, cuando se evalua en un $x+\epsilon$ tal que $\hat{F}(x)\neq \hat{F}(x+\epsilon)$

b) Usando la desigualdad de Dvoretzky-Kiefer-Wolfowitz, escriba una función en R que calcule y grafique una región de confianza para la función de distribución empírica. La función debe tomar como parámetros al conjunto de datos que se usan para contruir la función de distribución empírica.

c) Escriba una función en R que determine la gráfica Q-Q normal de un conjunto de datos. La función debe tomar como parámetro al conjunto de datos y deberá graficar contra el percentil estandarizado de la normal. Para poder comparar el ajuste más claramente, la función además deberá ajustar en rojo a la recta $sx + \bar{x}$ $s(=$desviación estándar muestral y $x$=media muestral). Usando esta función, determine la gráfica Q-Q normal. ¿Qué observa? \textbf{Nota:} La misma del inciso a).

d) Escriba una función en R que determine el gráfico de probabilidad normal. La función debe tomar como parámetro al conjunto de datos. ¿Qué observa? Nota: La misma del inciso a).

e) ¿Los datos anteriores se distribuyen normalmente? Argumente.

5. En este ejercicio repasará la estimación de densidades.

a) Escriba una función en R que estime una densidad por el método de kerneles. La función deberá recibir al punto $x$ donde se evalúa al estimador, al parámetro de suavidad $h$, al kernel que se utilizará en la estimación y al conjunto de datos.

\res Para el caso univariado, el $KDE$ está dado por 
$$\hat{f}=\frac{1}{nh} \sum_{i=1}^nK\left( \frac{x-x_1}{h}\right), \ \ \ \ x\in \mathbb{R}, \ h>0.$$
$K$ es la función Kernel, y $h$ es el acho de banda que determina la suavidad de la estimación. Procedemos a definir las funciones Kernel's, solo consideraremos las siguientes: gaussian, epanechnikov, rectangular, triangular, consine.
```{r}
# Definimos las funciones kernel:
kernel_gaussian <- function(x,x_i,h){
  dnorm((x-x_i)/h)
}

kernel_rectangular <- function(x,x_i,h){ 
  dunif((x_i - x)/h, min = -1, max = 1)
}

kernel_triangular <- function(x, x_i, h){
  u = (x_i-x)/h
  (1-abs(u))*(abs(u) <= 1)
}

kernel_epanechnikov <- function(x, x_i, h){
  u = (x_i - x)/h
  3/4*(1-u^2)*(abs(u) <= 1)
}

kernel_cosine <- function(x, x_i, h){
  u = (x_i - x)/h
  (1+cos(pi*u))/2*(abs(u) <= 1)
}
```
Una vez definido lo anterior procedemos a definir la función para estimar la densidad por el método de kerneles (https://github.com/JonasMoss/kdensity/blob/master/R/builtin_kernels.R):
```{r fig.width = 5.2, fig.asp = 0.62, fig.align = "center"}
kde <- function(x, h, kernel, D){
  f_hat <- 0
  n <- length(D)
  for (i in 1:n){
    if (kernel=="gaussian"){
      f_hat <- f_hat + kernel_gaussian(x, D[i], h)
    }
    else if(kernel=="epanechnikov"){
      f_hat <- f_hat + kernel_epanechnikov(x, D[i], h)
    }
    else if(kernel=="rectangular"){
      f_hat <- f_hat + kernel_rectangular(x, D[i], h)
    }
    else if(kernel=="triangular"){
      f_hat <- f_hat + kernel_triangular(x, D[i], h)
    }
    else if(kernel=="consine"){
      f_hat <- f_hat + kernel_cosine(x, D[i], h)
    }
    else{
      print("Kernel incorrecto")
      break()
    }
  }
  f_hat/(n*h)
}
```

b) Cargue en R al archivo “Tratamiento.csv”, el cual contiene la duración de los períodos de tratamiento (en días) de los pacientes de control en un estudio de suicidio. Utilice la función del inciso anterior para estimar la densidad del conjunto de datos para $h =20, 30, 60$. Grafique las densidades estimadas. ¿Cuál es el mejor valor para $h$? Argumente.

\res Cargamos los datos:
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
tratamiento <- read.csv("Tratamiento.csv")
```


```{r}
fd_tratamiento <-data.frame(x=seq(0,1000, 10))

fd_tratamiento$h_20<- kde(fd_tratamiento$x, 20, "gaussian", tratamiento$X1)

fd_tratamiento$h_30 <- kde(fd_tratamiento$x, 30, "gaussian", tratamiento$X1)

fd_tratamiento$h_60 <- kde(fd_tratamiento$x, 60, "gaussian", tratamiento$X1)

ggplot(fd_tratamiento, aes(x, h_20))+
  geom_line()

ggplot(fd_tratamiento, aes(x, h_30))+
  geom_line()

ggplot(fd_tratamiento, aes(x, h_60))+
  geom_line()
```


c) En el contexto de la estimación de densidades, escriba una función en R que determine el ancho de banda que optimiza al ISE. Grafique la densidad con ancho de banda óptimo para el conjunto de datos de “Tratamiento.csv”.

6. Cargue en R al conjunto de datos “Maíz.csv”, el cual contiene el precio mensual de la tonelada de maíz y el precio de la tonelada de tortillas en USD. En este ejercicio tendrá que estimar los coeficientes de una regresión lineal simple.

a) Calcule de forma explícita la estimación de los coeficientes via mínimos cuadrados y ajuste la regresión correspondiente. Concluya.

\res Cargamos los datos:
```{r}
maiz <- read.csv("Maiz.csv", col.names = c("p_tonelada_maiz", "p_tonelada_tortilla"))
head(maiz)
```


b) Calcule de forma explícita la estimación de los coeficientes via regresión no-paramétrica tipo kernel (ver Nadaraya, E. A. (1964). “On Estimating Regression”. Theory of Probability and its Applications. 9 (1): 141–2. doi:10.1137/1109020) y ajuste la regresión correspondiente. Concluya.



c) Compare ambos resultados. ¿Qué diferencias observa?

8. En este ejercicio se comprobará que tan buena es la aproximación dada por las reglas empíricas para algunas de las distribuciones estudiadas en la clase. Considerese las distribuciones $Unif(a =-3, b = 3)$, $Normal(0, 1)$, $Exponencial(2)$, $Gamma(\alpha= 2, \beta = 1)$, $Gamma(\alpha=3, \beta= 1)$, $Beta(\alpha= 2, \beta= 2)$, $Weibull(\alpha= 4, \beta= 1)$ y Lognormal$(\mu = 3, \sigma = 2)$.

a) Para cada una de las distribuciones anteriores, haga una tabla que muestre las probabilidades contenidas en los intervalos $(\mu - k\sigma, \mu + k\sigma)$, para $k = 1, 2, 3$. Utilice las fórmulas de las medias y varianzas contenidas en las notas para determinar $\mu$ y $\sigma$ en cada caso. Puede usar R para determinar las probabilidades pedidas.

\res Determinemos para cada distribución su media y varianza las cuales se pueden calcular con la table

\begin{table}[H]
\centering
\begin{tabular}{ccc}
Distribución de $X$ & $\mE[X]$ & Var($X$)\\ \hline \hline
$Unif(a,b)$& $\frac{b+a}{2}$ & $\frac{(a-b)^2}{12}$\\  
\\
$Normal(\mu, \sigma)$ & $\mu$& $\sigma^2$\\
\\
$Exponencial(\theta)$ & $\theta$& $\theta^2$\\
\\
$Gamma(\alpha, \beta)$ &$\alpha \beta$ & $\alpha\beta^2$\\
\\
$Beta(\alpha,\beta)$ &$\frac{\alpha}{\alpha+\beta}$&$\frac{\alpha \beta}{(\alpha+\beta^2)(\alpha +\beta+1)}$ \\
\\
$Weibull(\alpha,\beta)$ &$\alpha^{-\frac{1}{\beta}}\Gamma \left( \frac{1}{\beta}\right)$ & $\alpha^{-\frac{1}{\beta}} \left(\Gamma \left(\frac{2}{\beta}+1 \right)-\Gamma^2\left( \frac{1}{\beta}+1\right) \right)$ \\
\\
$LogNormal(\mu,\sigma)$& $e^{\mu+\frac{\sigma^2}{2}}$& $e^{2\mu+\sigma^2}\left(e^{\sigma^2}-1 \right)$\\
\hline \hline
\end{tabular}
\end{table}

Para este problema sería:
\begin{table}[H]
\centering
\begin{tabular}{cccc}
Distribución de $X$ & $\mE[X]$ & Var($X$) &$\sigma$  \\ \hline \hline
$Unif(-3,3)$& $\frac{3-3}{2}=\textbf{0}$ & $\frac{(a-b)^2}{12}=\frac{(-3-3)^2}{12}=3$& 1.73\\  
\\
$Normal(0,1)$ & $\textbf{0}$& $\textbf{1}$ & 1\\
\\
$Exponencial(2)$ & $\textbf{2}$& $\textbf{4}$ & 2\\
\\
$Gamma(2, 1)$ &$\textbf{2}$ & $\textbf{2}$ & 1.41\\
\\
$Gamma(3, 1)$ &$\textbf{3}$ & $\textbf{3}$ &1.73\\
\\
$Beta(2,2)$ &$\frac{2}{2+2}=\frac{1}{2}$&$\frac{2 (2)}{(2+2^2)(2 +2+1)}=\frac{4}{30}$ & 3\\
\\
$Weibull(\alpha,\beta)$ &$\alpha^{-\frac{1}{\beta}}\Gamma \left( \frac{1}{\beta}\right)$ & $\alpha^{-\frac{1}{\beta}} \left(\Gamma \left(\frac{2}{\beta}+1 \right)-\Gamma^2\left( \frac{1}{\beta}+1\right) \right)$ \\
\\
$LogNormal(3,2)$& $e^{3+\frac{2^2}{2}}=148.41$& $e^{2(3)+4}\left(e^{3} -1\right)$ & 1086.544\\
\hline \hline
\end{tabular}
\end{table}

Calculemos las probabilidades:
```{r}
parametros_distribuciones <- data.frame(distribucion=c("Unif","Normal", "Exp", "Gamma","Gamma_2", "Beta", "Weibull", "LNormal"), mu = c(0, 0, 2, 2, 3, 0.5, 1, 148.41), std=c(1.73, 1, 2, 1.41, 1.73, 0.342,0.25, 10865))

resultados_uniforme <- parametros_distribuciones %>% filter(distribucion=="Unif")%>%
  mutate(prob_between_x_s=punif(mu+std, min=-3, max=3)-punif(mu-std, min=-3, max=3),
         prob_between_x_2s=punif(mu+2*std, min=-3, max=3)-punif(mu-2*std, min=-3, max=3),
         prob_between_x_3s=punif(mu+3*std, min=-3, max=3)-punif(mu-3*std, min=-3, max=3))

resultados_normal <- parametros_distribuciones %>% filter(distribucion=="Normal")%>%
  mutate(prob_between_x_s=pnorm(mu+std)-punif(mu-std),
         prob_between_x_2s=pnorm(mu+2*std)-pnorm(mu-2*std),
         prob_between_x_3s=pnorm(mu+3*std)-pnorm(mu-3*std))

resultados_exponencial <- parametros_distribuciones %>% filter(distribucion=="Exp")%>%
  mutate(prob_between_x_s=pexp(mu+std, 2)-pexp(mu-std,2),
         prob_between_x_2s=pexp(mu+2*std, 2)-pexp(mu-2*std, 2),
         prob_between_x_3s=pexp(mu+3*std, 2)-pexp(mu-3*std, 2))

resultados_gamma <- parametros_distribuciones %>% filter(distribucion=="Gamma")%>%
  mutate(prob_between_x_s=pgamma(mu+std, 2, 1)-pgamma(mu-std, 2, 1),
         prob_between_x_2s=pgamma(mu+2*std, 2, 1)-pgamma(mu-2*std, 2, 1),
         prob_between_x_3s=pgamma(mu+3*std, 2, 1)-pgamma(mu-3*std, 2, 1))

resultados_gamma2 <- parametros_distribuciones %>% filter(distribucion=="Gamma")%>%
  mutate(prob_between_x_s=pgamma(mu+std, 3, 1)-pgamma(mu-std, 3, 1),
         prob_between_x_2s=pgamma(mu+2*std, 3, 1)-pgamma(mu-2*std, 3, 1),
         prob_between_x_3s=pgamma(mu+3*std, 3, 1)-pgamma(mu-3*std, 3, 1))

resultados_beta <- parametros_distribuciones %>% filter(distribucion=="Beta")%>%
  mutate(prob_between_x_s=pgamma(mu+std, 2, 2)-pgamma(mu-std, 2, 2),
         prob_between_x_2s=pgamma(mu+2*std, 2, 2)-pgamma(mu-2*std, 2, 2),
         prob_between_x_3s=pgamma(mu+3*std, 2, 2)-pgamma(mu-3*std, 2, 2))

resultados_weibull <- parametros_distribuciones %>% filter(distribucion=="Weibull")%>%
  mutate(prob_between_x_s=pgamma(mu+std, 4, 1)-pgamma(mu-std, 3, 1),
         prob_between_x_2s=pgamma(mu+2*std, 4, 1)-pgamma(mu-2*std, 4, 1),
         prob_between_x_3s=pgamma(mu+3*std, 4, 1)-pgamma(mu-3*std, 4, 1))

resultados_lnorm <- parametros_distribuciones %>% filter(distribucion=="LNormal")%>%
  mutate(prob_between_x_s=pgamma(mu+std, 3, 2)-pgamma(mu-std, 3, 2),
         prob_between_x_2s=pgamma(mu+2*std, 3, 2)-pgamma(mu-2*std, 3, 2),
         prob_between_x_3s=pgamma(mu+3*std, 3, 2)-pgamma(mu-3*std, 3, 2))

resultados_teoricos <- rbind(resultados_beta, resultados_exponencial, resultados_gamma, resultados_gamma2,
                             resultados_lnorm, resultados_normal, resultados_uniforme, resultados_weibull)

resultados_teoricos %>% select(distribucion, prob_between_x_s, prob_between_x_2s, prob_between_x_3s)
 
```



b) En R, simule $n = 1000$ muestras de cada una de las distribuciones anteriores y calcule la media muestral $\bar{x}$ y la varianza muestral $s^2$ como se mencionó en la clase. En cada caso, calcule la proporción de observaciones que quedan en los intervalos $(\bar{x}- k, \bar{x} + ks)$), para k = 1, 2, 3. Reporte sus hallazgos en una tabla como la del inciso anterior. ¿Qué tanto se parecen la tabla de este inciso y la del anterior?

\res Calculemos 
```{r}
set.seed(08081997)

muestras_simuladas<- data.frame(x=c(runif(1000, -3, 3), rnorm(1000), rexp(1000, 2),
rgamma(1000, 2, 1), rgamma(1000, 3, 1), rbeta(1000, 2, 2), rweibull(1000, 4, 1), 
rlnorm(1000,meanlog= 3, sdlog = 2)), distribucion=c(rep("Uniforme", 1000), rep("Normal", 1000), 
rep("Exp", 1000), rep("Gamma_1", 1000), rep("Gamma_2", 1000), rep("Beta", 1000), 
rep("Weib", 1000), rep("LNormal", 1000)))

estadisticos_muestrales <- muestras_simuladas %>% group_by(distribucion) %>% 
  summarise(mean_muestral = mean(x),
            std_muestral = sqrt(var(x)))

head(estadisticos_muestrales,8)

resultados <- merge(muestras_simuladas, estadisticos_muestrales)

resultados %>% mutate( 
  x_s = ifelse(x>(mean_muestral-std_muestral) & x<(mean_muestral+std_muestral), 1, 0),
  x_2s = ifelse(x>(mean_muestral-2*std_muestral) & x<(mean_muestral+2*std_muestral), 1, 0),
  x_3s = ifelse(x>(mean_muestral-3*std_muestral) & x<(mean_muestral+3*std_muestral), 1, 0)) %>%
  group_by(distribucion) %>% summarise(propor_x_s = sum(x_s)/1000,
                                       propor_x_2s = sum(x_2s)/1000,
                                       propor_x_3s = sum(x_3s)/1000)
```

```{r}
resultados_teoricos %>% select(distribucion, prob_between_x_s, prob_between_x_2s, prob_between_x_3s)
```

